<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>
  <!-- Load the Trello Power-Up library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    TrelloPowerUp.initialize({
      // Add a button to each card
      'card-buttons': function (t, options) {
        return [
          {
            icon: './calender.png',
            text: 'Days since',
            callback: function (t) {
              // Get the current card
              return t.card('id', 'name').then(function (card) {
                // Calculate the number of days since the card was created
                const cardDate = new Date(1000 * parseInt(card.id.substring(0, 8), 16));
                const currentDate = new Date();
                const daysSinceCardCreated = Math.floor((currentDate - cardDate) / (1000 * 60 * 60 * 24));

                // Create the badge
                let badgeText = ""
                if (daysSinceCardCreated == 1) {
                  badgeText = "1 day";
                } else {
                  badgeText = daysSinceCardCreated + " days";
                }
                // Set the badge text in the card's shared data
                t.get('card', 'shared').then(function (data) {
                  t.set('card', 'shared', { show: !data.show, badge: badgeText })
                })
              })
            }
          }]
      },
      // Display the badge on the card
      'card-badges': function (t, options) {
        let cardAttachments = options.attachments
        return t.get('card', 'shared')
          .then(function (data) {
            //  If the show property of the shared data is set to true, display the badge
            console.log(JSON.stringify(data))
            if (data.show) {
              return t.card("name").get("name").then(function (cardName) {
                return [
                  {
                    dynamic: function () {
                      return {
                        text: data.badge,
                        icon: "./calender.png",
                        color: "green",
                        refresh: 10, // in seconds
                      }
                    }
                  }]
              })
            }
          })
      }
    });
  </script>
</body>

</html>
